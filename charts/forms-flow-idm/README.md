# formsflow.ai Identity Management

The **formsflow.ai** framework could be hooked up with any OpenID Connect compliant Identity Management Server. To date, we have only tested [Keycloak](https://github.com/keycloak/keycloak)


## Introduction

This chart bootstraps a forms-flow-idm deployment on a [Kubernetes](https://kubernetes.io) cluster using the [Helm](https://helm.sh) package manager.


## Installing the Chart

To install the chart with the release name `forms-flow-idm`:

```console
helm upgrade --install forms-flow-idm forms-flow-idm
```

Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`. For example,


```console
helm upgrade --install forms-flow-idm forms-flow-idm  --set keycloak.ingress.hostname=KEYCLOAK_URL --set postgresql-ha.postgresql.podSecurityContext.enabled=true --set keycloak.ingress.ingressClassName=INGRESS_CLASS 
```

> Note: You need to substitute the placeholders `DOMAIN_NAME`, `INGRESS_CLASS` AND `KEYCLOAK_URL` with a reference to your Helm chart registry and repository. For example, in the case of Formsflow, you need to use `DOMAIN_NAME=example.com` and `INGRESS_CLASS=nginx`

These commands deploy Forms-flow-idm on the Kubernetes cluster

> **Tip**: List all releases using `helm list`

### Resource requests and limits

Forms-flow-idm charts allow setting resource requests and limits for all containers inside the chart deployment. These are inside the `resources` value (check parameter table). Setting requests is essential for production workloads and these should be adapted to your specific use case.

```yaml
  resources:
    limits:
      cpu: 700m
      memory: 3Gi
    requests:
      cpu: 500m
      memory: 2Gi
```

### Change Forms-flow-idm version

To modify the Forms-flow-idm version used in this chart you can specify a valid image tag using the `image.tag` parameter. For example, `image.tag=X.Y.Z`. This approach is also applicable to other images like exporters.

```yaml
  image:
    registry: "docker.io"
    repository: "bitnami/keycloak" 
    tag: X.Y.Z
```

## Parameters



### Keycloak Parameters

| Parameter                                 | Description                                                           | Default                                                          |
|-------------------------------------------|-----------------------------------------------------------------------|------------------------------------------------------------------|
| `keycloak.replicas`                       | Number of Keycloak replicas                                           | `1`                                                              |
| `keycloak.auth.adminUser`                 | Admin user for Keycloak                                               | `admin`                                                          |
| `keycloak.production`                     | Set Keycloak in production mode                                       | `true`                                                           |
| `keycloak.proxy`                          | Proxy mode for Keycloak                                               | `edge`                                                           |
| `keycloak.tls.enabled`                    | Enable TLS for Keycloak                                               | `true`                                                           |
| `keycloak.tls.autoGenerated`              | Auto-generate TLS certificates                                        | `true`                                                           |
| `keycloak.extraEnvVars`                   | Extra environment variables for Keycloak                              | `""`                                                        |
| `keycloak.extraVolumes`                   | Extra volumes for Keycloak                                            | `""`                                                        |
| `keycloak.extraVolumeMounts`              | Extra volume mounts for Keycloak                                      | `""`                                                        |
| `keycloak.initContainers`                 | Init containers for Keycloak                                          | `""`                                                        |
| `keycloak.image.registry`                 | Docker registry for the Keycloak image                                | `docker.io`                                                      |
| `keycloak.image.repository`               | Repository for the Keycloak image                                     | `bitnami/keycloak`                                               |
| `keycloak.image.tag`                      | Tag for the Keycloak image                                            | `KEYCLOAK_IMAGE_TAG`                                                         |
| `keycloak.postgresql.enabled`             | Enable internal PostgreSQL                                            | `false`                                                          |
| `keycloak.externalDatabase.host`          | Host for the external database                                        | `forms-flow-idm-postgresql-ha-pgpool`                            |
| `keycloak.externalDatabase.port`          | Port for the external database                                        | `5432`                                                           |
| `keycloak.externalDatabase.user`          | Username for the external database                                    | `postgres`                                                       |
| `keycloak.externalDatabase.database`      | Database name for the external database                               | `postgres`                                                       |
| `keycloak.externalDatabase.password`      | Password for the external database                                    | `postgres`                                                       |
| `keycloak.resources.limits.cpu`           | CPU limit for the Keycloak container                                  | `700m`                                                           |
| `keycloak.resources.limits.memory`        | Memory limit for the Keycloak container                               | `3Gi`                                                            |
| `keycloak.resources.requests.cpu`         | CPU request for the Keycloak container                                | `500m`                                                           |
| `keycloak.resources.requests.memory`      | Memory request for the Keycloak container                             | `2Gi`                                                            |
| `keycloak.containerSecurityContext.enabled`| Enable container security context for Keycloak                        | `false`                                                          |
| `keycloak.podSecurityContext.enabled`     | Enable pod security context for Keycloak                              | `false`                                                          |
| `keycloak.keycloakConfigCli.containerSecurityContext.enabled`| Enable container security context for Keycloak Config CLI             | `false`                                                          |
| `keycloak.keycloakConfigCli.podSecurityContext.enabled`| Enable pod security context for Keycloak Config CLI                  | `false`                                                          |
| `keycloak.service.type`                   | Service type for Keycloak                                             | `ClusterIP`                                                      |
| `keycloak.ingress.ingressClassName`       | Ingress class name for Keycloak                                       | `""`                                                             |
| `keycloak.ingress.annotations`            | Annotations for the Keycloak Ingress                                  | `{}`                                                             |
| `keycloak.ingress.enabled`                | Enable Ingress for Keycloak                                           | `true`                                                           |
| `keycloak.ingress.hostname`               | Hostname for the Keycloak Ingress                                     | `#DEFINE_ME`                                                     |
| `keycloak.ingress.pathtype`               | Path type for the Keycloak Ingress                                    | `Prefix`                                                         |
| `keycloak.ingress.servicePort`            | Service port for the Keycloak Ingress                                 | `http`                                                           |
| `keycloak.ingress.tls`                    | Enable TLS for the Keycloak Ingress                                   | `true`                                                           |
| `keycloak.ingress.extraTls`               | Additional TLS configuration for the Keycloak Ingress                 | `[]`                                                             |
| `keycloak.httpRelativePath`               | Relative path for Keycloak HTTP                                       | `/auth/`                                                         |
| `keycloak.cache.enabled`                  | Enable cache for Keycloak                                             | `false`                                                          |

### PostgreSQL High Availability Parameters

| Parameter                                 | Description                                                           | Default                                                          |
|-------------------------------------------|-----------------------------------------------------------------------|------------------------------------------------------------------|
| `postgresql-ha.enabled`                   | Enable PostgreSQL High Availability                                   | `true`                                                           |
| `postgresql-ha.postgresql.enabled`        | Enable internal PostgreSQL                                            | `true`                                                           |
| `postgresql-ha.postgresql.image.registry` | Docker registry for the PostgreSQL image                              | `docker.io`                                                      |
| `postgresql-ha.postgresql.image.repository`| Repository for the PostgreSQL image                                   | `bitnami/postgresql-repmgr`                                      |
| `postgresql-ha.postgresql.image.tag`      | Tag for the PostgreSQL image                                          | `IMAGE_TAG`                                            |
| `postgresql-ha.postgresql.fullnameOverride`| Full name override for PostgreSQL                                     | `forms-flow-idm-postgresql`                                      |
| `postgresql-ha.postgresql.replicaCount`   | Replica count for PostgreSQL                                          | `3`                                                              |
| `postgresql-ha.postgresql.containerPorts.postgresql`| Container port for PostgreSQL                                         | `5432`                                                           |
| `postgresql-ha.postgresql.podSecurityContext.enabled`| Enable pod security context for PostgreSQL                            | `false`                                                          |
| `postgresql-ha.postgresql.containerSecurityContext.enabled`| Enable container security context for PostgreSQL                      | `false`                                                          |
| `postgresql-ha.postgresql.containerSecurityContext.runAsNonRoot`| Run PostgreSQL container as non-root                                  | `true`                                                           |
| `postgresql-ha.postgresql.livenessProbe.enabled`| Enable liveness probe for PostgreSQL                                  | `false`                                                          |
| `postgresql-ha.postgresql.readinessProbe.enabled`| Enable readiness probe for PostgreSQL                                 | `false`                                                          |
| `postgresql-ha.postgresql.username`       | Username for PostgreSQL                                               | `postgres`                                                       |
| `postgresql-ha.postgresql.password`       | Password for PostgreSQL                                               | `postgres`                                                       |
| `postgresql-ha.postgresql.database`       | Database name for PostgreSQL                                          | `forms-flow-idm`                                                 |
| `postgresql-ha.postgresql.postgresPassword`| Postgres user password for PostgreSQL                                 | `changeme`                                                       |
| `postgresql-ha.postgresql.repmgrUsername` | Replication manager username for PostgreSQL                           | `repmgr`                                                         |
| `postgresql-ha.postgresql.repmgrPassword` | Replication manager password for PostgreSQL                           | `changeme`                                                       |
| `postgresql-ha.postgresql.repmgrDatabase` | Replication manager database name for PostgreSQL                      | `repmgr`                                                         |
| `postgresql-ha.postgresql.repmgrLogLevel` | Replication manager log level for PostgreSQL                          | `NOTICE`                                                         |
| `postgresql-ha.postgresql.repmgrConnectTimeout`| Replication manager connect timeout for PostgreSQL                    | `5`                                                              |
| `postgresql-ha.postgresql.repmgrReconnectAttempts`| Replication manager reconnect attempts for PostgreSQL                 | `2`                                                              |
| `postgresql-ha.postgresql.repmgrReconnectInterval`| Replication manager reconnect interval for PostgreSQL                 | `3`                                                              |
| `postgresql-ha.postgresql.repmgrFenceOldPrimary`| Enable fencing of old primary for PostgreSQL                          | `false`                                                          |
| `postgresql-ha.postgresql.repmgrChildNodesCheckInterval`| Replication manager child nodes check interval for PostgreSQL         | `5`                                                              |
| `postgresql-ha.postgresql.repmgrChildNodesConnectedMinCount`| Minimum count of connected child nodes for PostgreSQL                 | `1`                                                              |
| `postgresql-ha.postgresql.repmgrChildNodesDisconnectTimeout`| Replication manager child nodes disconnect timeout for PostgreSQL     | `30`                                                             |
| `postgresql-ha.postgresql.initdbScripts.init_script.sql`| Initialization script for PostgreSQL                                  | `""`                                                        |
| `postgresql-ha.pgpool.image.registry`     | Docker registry for the Pgpool image                                  | `docker.io`                                                      |
| `postgresql-ha.pgpool.image.repository`   | Repository for the Pgpool image                                       | `bitnami/pgpool`                                                 |
| `postgresql-ha.pgpool.image.tag`          | Tag for the Pgpool image                                              | `PGPOOL_IMAGE_TAG`                                             |
| `postgresql-ha.pgpool.image.pullPolicy`   | Pull policy for the Pgpool image                                      | `IfNotPresent`                                                   |
| `postgresql-ha.pgpool.replicaCount`       | Replica count for Pgpool                                              | `1`                                                              |
| `postgresql-ha.pgpool.podSecurityContext.enabled`| Enable pod security context for Pgpool                                | `false`                                                          |
| `postgresql-ha.pgpool.podSecurityContext.fsGroup`| FS group for Pgpool                                                   | `1001`                                                           |
| `postgresql-ha.pgpool.containerSecurityContext.enabled`| Enable container security context for Pgpool                          | `false`                                                          |
| `postgresql-ha.pgpool.containerSecurityContext.runAsNonRoot`| Run Pgpool container as non-root                                      | `true`                                                           |
| `postgresql-ha.pgpool.containerSecurityContext.readOnlyRootFilesystem`| Read-only root filesystem for Pgpool                                  | `false`                                                          |
| `postgresql-ha.pgpool.livenessProbe.enabled`| Enable liveness probe for Pgpool                                      | `false`                                                          |
| `postgresql-ha.pgpool.readinessProbe.enabled`| Enable readiness probe for Pgpool                                     | `false`                                                          |
| `postgresql-ha.pgpool.containerPorts.postgresql`| Container port for Pgpool                                             | `5432`                                                           |
| `postgresql-ha.pgpool.adminUsername`      | Admin username for Pgpool                                             | `admin`                                                          |
| `postgresql-ha.pgpool.adminPassword`      | Admin password for Pgpool                                             | `changeme`                                                       |
| `postgresql-ha.pgpool.service.type`       | Service type for Pgpool                                               | `ClusterIP`                                                      |
| `postgresql-ha.pgpool.service.ports.metrics`| Metrics port for Pgpool                                               | `9187`                                                           |
| `postgresql-ha.persistence.enabled`       | Enable persistence for PostgreSQL                                     | `true`                                                           |
| `postgresql-ha.persistence.storageClass`  | Storage class for PostgreSQL                                          | `""`                                                             |
| `postgresql-ha.persistence.mountPath`     | Mount path for PostgreSQL                                             | `/bitnami/postgresql`                                            |
| `postgresql-ha.persistence.accessModes`   | Access modes for PostgreSQL                                           | `["ReadWriteOnce"]`                                              |
| `postgresql-ha.persistence.size`          | Persistence size for PostgreSQL                                       | `8Gi`                                                            |
| `postgresql-ha.service.type`              | Service type for PostgreSQL                                           | `ClusterIP`                                                      |
| `postgresql-ha.service.ports.postgresql`  | Service port for PostgreSQL                                           | `5432`                                                           |
| `postgresql-ha.service.portName`          | Service port name for PostgreSQL                                      | `postgresql`                                                     |
| `postgresql-ha.service.nodePorts.postgresql`| Node port for PostgreSQL                                              | `""`                                                             |

